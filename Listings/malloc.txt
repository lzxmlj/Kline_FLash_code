; generated by Component: ARM Compiler 5.06 update 4 (build 422) Tool: ArmCC [4d3604]
; commandline ArmCC [--c99 --list --split_sections --debug -c --asm --interleave -o.\objects\malloc.o --asm_dir=.\Listings\ --list_dir=.\Listings\ --depend=.\objects\malloc.d --cpu=Cortex-M4.fp --apcs=interwork -O0 --diag_suppress=9931 -I.\STM_Lib\inc -I.\USER -I.\CMSIS -I.\BoardHardware -I.\FATFS\src -I.\FATFS\exfuns -I.\MALLOC -I.\RTE\_407 -Ie:\Keil_v5\ARM\PACK\Keil\STM32F4xx_DFP\2.11.0\Drivers\CMSIS\Device\ST\STM32F4xx\Include -Ie:\Keil_v5\ARM\CMSIS\Include -D__UVISION_VERSION=523 -DSTM32F407xx -DUSE_STDPERIPH_DRIVER --omf_browse=.\objects\malloc.crf MALLOC\malloc.c]
                          THUMB

                          AREA ||i.my_mem_free||, CODE, READONLY, ALIGN=2

                  my_mem_free PROC
;;;120    //����ֵ:0,�ͷųɹ�;1,�ͷ�ʧ��;  
;;;121    u8 my_mem_free(u8 memx,u32 offset)  
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;122    {  
000004  4604              MOV      r4,r0
000006  460e              MOV      r6,r1
;;;123        int i;  
;;;124        if(!mallco_dev.memrdy[memx])//δ��ʼ��,��ִ�г�ʼ��
000008  4815              LDR      r0,|L1.96|
00000a  5d00              LDRB     r0,[r0,r4]
00000c  b938              CBNZ     r0,|L1.30|
;;;125    	{
;;;126    		mallco_dev.init(memx);    
00000e  4814              LDR      r0,|L1.96|
000010  3820              SUBS     r0,r0,#0x20
000012  6801              LDR      r1,[r0,#0]  ; mallco_dev
000014  4620              MOV      r0,r4
000016  4788              BLX      r1
;;;127            return 1;//δ��ʼ��  
000018  2001              MOVS     r0,#1
                  |L1.26|
;;;128        }  
;;;129        if(offset<memsize[memx])//ƫ�����ڴ����. 
;;;130        {  
;;;131            int index=offset/memblksize[memx];			//ƫ�������ڴ�����  
;;;132            int nmemb=mallco_dev.memmap[memx][index];	//�ڴ������
;;;133            for(i=0;i<nmemb;i++)  						//�ڴ������
;;;134            {  
;;;135                mallco_dev.memmap[memx][index+i]=0;  
;;;136            }  
;;;137            return 0;  
;;;138        }else return 2;//ƫ�Ƴ�����.  
;;;139    }  
00001a  e8bd81f0          POP      {r4-r8,pc}
                  |L1.30|
00001e  4811              LDR      r0,|L1.100|
000020  f8500024          LDR      r0,[r0,r4,LSL #2]     ;129
000024  42b0              CMP      r0,r6                 ;129
000026  d919              BLS      |L1.92|
000028  480f              LDR      r0,|L1.104|
00002a  f8500024          LDR      r0,[r0,r4,LSL #2]     ;131
00002e  fbb6f1f0          UDIV     r1,r6,r0              ;131
000032  480b              LDR      r0,|L1.96|
000034  380c              SUBS     r0,r0,#0xc            ;132
000036  f8500024          LDR      r0,[r0,r4,LSL #2]     ;132
00003a  f8302011          LDRH     r2,[r0,r1,LSL #1]     ;132
00003e  2500              MOVS     r5,#0                 ;133
000040  e008              B        |L1.84|
                  |L1.66|
000042  2300              MOVS     r3,#0                 ;135
000044  4806              LDR      r0,|L1.96|
000046  380c              SUBS     r0,r0,#0xc            ;135
000048  f8500024          LDR      r0,[r0,r4,LSL #2]     ;135
00004c  194f              ADDS     r7,r1,r5              ;135
00004e  f8203017          STRH     r3,[r0,r7,LSL #1]     ;135
000052  1c6d              ADDS     r5,r5,#1              ;133
                  |L1.84|
000054  4295              CMP      r5,r2                 ;133
000056  dbf4              BLT      |L1.66|
000058  2000              MOVS     r0,#0                 ;137
00005a  e7de              B        |L1.26|
                  |L1.92|
00005c  2002              MOVS     r0,#2                 ;138
00005e  e7dc              B        |L1.26|
;;;140    //�ͷ��ڴ�(�ⲿ����) 
                          ENDP

                  |L1.96|
                          DCD      mallco_dev+0x20
                  |L1.100|
                          DCD      memsize
                  |L1.104|
                          DCD      memblksize

                          AREA ||i.my_mem_init||, CODE, READONLY, ALIGN=2

                  my_mem_init PROC
;;;68     //memx:�����ڴ��
;;;69     void my_mem_init(u8 memx)  
000000  b510              PUSH     {r4,lr}
;;;70     {  
000002  4604              MOV      r4,r0
;;;71         mymemset(mallco_dev.memmap[memx], 0,memtblsize[memx]*2);//�ڴ�״̬����������  
000004  490c              LDR      r1,|L2.56|
000006  f8511024          LDR      r1,[r1,r4,LSL #2]
00000a  004a              LSLS     r2,r1,#1
00000c  490b              LDR      r1,|L2.60|
00000e  f8510024          LDR      r0,[r1,r4,LSL #2]
000012  2100              MOVS     r1,#0
000014  f7fffffe          BL       mymemset
;;;72     	mymemset(mallco_dev.membase[memx], 0,memsize[memx]);	//�ڴ��������������  
000018  4909              LDR      r1,|L2.64|
00001a  f8512024          LDR      r2,[r1,r4,LSL #2]
00001e  4907              LDR      r1,|L2.60|
000020  390c              SUBS     r1,r1,#0xc
000022  f8510024          LDR      r0,[r1,r4,LSL #2]
000026  2100              MOVS     r1,#0
000028  f7fffffe          BL       mymemset
;;;73     	mallco_dev.memrdy[memx]=1;								//�ڴ�����ʼ��OK  
00002c  2101              MOVS     r1,#1
00002e  4803              LDR      r0,|L2.60|
000030  300c              ADDS     r0,r0,#0xc
000032  5501              STRB     r1,[r0,r4]
;;;74     }  
000034  bd10              POP      {r4,pc}
;;;75     //��ȡ�ڴ�ʹ����
                          ENDP

000036  0000              DCW      0x0000
                  |L2.56|
                          DCD      memtblsize
                  |L2.60|
                          DCD      mallco_dev+0x14
                  |L2.64|
                          DCD      memsize

                          AREA ||i.my_mem_malloc||, CODE, READONLY, ALIGN=2

                  my_mem_malloc PROC
;;;91     //����ֵ:0XFFFFFFFF,�������;����,�ڴ�ƫ�Ƶ�ַ 
;;;92     u32 my_mem_malloc(u8 memx,u32 size)  
000000  e92d47f0          PUSH     {r4-r10,lr}
;;;93     {  
000004  4604              MOV      r4,r0
000006  460f              MOV      r7,r1
;;;94         signed long offset=0;  
000008  2500              MOVS     r5,#0
;;;95         u32 nmemb;	//��Ҫ���ڴ����  
;;;96     	u32 cmemb=0;//�������ڴ����
00000a  46a9              MOV      r9,r5
;;;97         u32 i;  
;;;98         if(!mallco_dev.memrdy[memx])mallco_dev.init(memx);//δ��ʼ��,��ִ�г�ʼ�� 
00000c  4823              LDR      r0,|L3.156|
00000e  5d00              LDRB     r0,[r0,r4]
000010  b920              CBNZ     r0,|L3.28|
000012  4822              LDR      r0,|L3.156|
000014  3820              SUBS     r0,r0,#0x20
000016  6801              LDR      r1,[r0,#0]  ; mallco_dev
000018  4620              MOV      r0,r4
00001a  4788              BLX      r1
                  |L3.28|
;;;99         if(size==0)return 0XFFFFFFFF;//����Ҫ����
00001c  b91f              CBNZ     r7,|L3.38|
00001e  f04f30ff          MOV      r0,#0xffffffff
                  |L3.34|
;;;100        nmemb=size/memblksize[memx];  	//��ȡ��Ҫ����������ڴ����
;;;101        if(size%memblksize[memx])nmemb++;  
;;;102        for(offset=memtblsize[memx]-1;offset>=0;offset--)//���������ڴ������  
;;;103        {     
;;;104    		if(!mallco_dev.memmap[memx][offset])cmemb++;//�������ڴ��������
;;;105    		else cmemb=0;								//�����ڴ������
;;;106    		if(cmemb==nmemb)							//�ҵ�������nmemb�����ڴ��
;;;107    		{
;;;108                for(i=0;i<nmemb;i++)  					//��ע�ڴ��ǿ� 
;;;109                {  
;;;110                    mallco_dev.memmap[memx][offset+i]=nmemb;  
;;;111                }  
;;;112                return (offset*memblksize[memx]);//����ƫ�Ƶ�ַ  
;;;113    		}
;;;114        }  
;;;115        return 0XFFFFFFFF;//δ�ҵ����Ϸ����������ڴ��  
;;;116    }  
000022  e8bd87f0          POP      {r4-r10,pc}
                  |L3.38|
000026  481e              LDR      r0,|L3.160|
000028  f8500024          LDR      r0,[r0,r4,LSL #2]     ;100
00002c  fbb7f6f0          UDIV     r6,r7,r0              ;100
000030  481b              LDR      r0,|L3.160|
000032  f8500024          LDR      r0,[r0,r4,LSL #2]     ;101
000036  fbb7f1f0          UDIV     r1,r7,r0              ;101
00003a  fb007011          MLS      r0,r0,r1,r7           ;101
00003e  b100              CBZ      r0,|L3.66|
000040  1c76              ADDS     r6,r6,#1              ;101
                  |L3.66|
000042  4818              LDR      r0,|L3.164|
000044  f8500024          LDR      r0,[r0,r4,LSL #2]     ;102
000048  1e45              SUBS     r5,r0,#1              ;102
00004a  e022              B        |L3.146|
                  |L3.76|
00004c  4813              LDR      r0,|L3.156|
00004e  380c              SUBS     r0,r0,#0xc            ;104
000050  f8500024          LDR      r0,[r0,r4,LSL #2]     ;104
000054  f8300015          LDRH     r0,[r0,r5,LSL #1]     ;104
000058  b910              CBNZ     r0,|L3.96|
00005a  f1090901          ADD      r9,r9,#1              ;104
00005e  e001              B        |L3.100|
                  |L3.96|
000060  f04f0900          MOV      r9,#0                 ;105
                  |L3.100|
000064  45b1              CMP      r9,r6                 ;106
000066  d113              BNE      |L3.144|
000068  f04f0800          MOV      r8,#0                 ;108
00006c  e009              B        |L3.130|
                  |L3.110|
00006e  480b              LDR      r0,|L3.156|
000070  380c              SUBS     r0,r0,#0xc            ;110
000072  f8500024          LDR      r0,[r0,r4,LSL #2]     ;110
000076  eb050208          ADD      r2,r5,r8              ;110
00007a  f8206012          STRH     r6,[r0,r2,LSL #1]     ;110
00007e  f1080801          ADD      r8,r8,#1              ;108
                  |L3.130|
000082  45b0              CMP      r8,r6                 ;108
000084  d3f3              BCC      |L3.110|
000086  4806              LDR      r0,|L3.160|
000088  f8500024          LDR      r0,[r0,r4,LSL #2]     ;112
00008c  4368              MULS     r0,r5,r0              ;112
00008e  e7c8              B        |L3.34|
                  |L3.144|
000090  1e6d              SUBS     r5,r5,#1              ;102
                  |L3.146|
000092  2d00              CMP      r5,#0                 ;102
000094  dada              BGE      |L3.76|
000096  f04f30ff          MOV      r0,#0xffffffff        ;115
00009a  e7c2              B        |L3.34|
;;;117    //�ͷ��ڴ�(�ڲ�����) 
                          ENDP

                  |L3.156|
                          DCD      mallco_dev+0x20
                  |L3.160|
                          DCD      memblksize
                  |L3.164|
                          DCD      memtblsize

                          AREA ||i.my_mem_perused||, CODE, READONLY, ALIGN=2

                  my_mem_perused PROC
;;;77     //����ֵ:ʹ����(0~100)
;;;78     u8 my_mem_perused(u8 memx)  
000000  b510              PUSH     {r4,lr}
;;;79     {  
000002  4601              MOV      r1,r0
;;;80         u32 used=0;  
000004  2300              MOVS     r3,#0
;;;81         u32 i;  
;;;82         for(i=0;i<memtblsize[memx];i++)  
000006  2200              MOVS     r2,#0
000008  e007              B        |L4.26|
                  |L4.10|
;;;83         {  
;;;84             if(mallco_dev.memmap[memx][i])used++; 
00000a  480b              LDR      r0,|L4.56|
00000c  f8500021          LDR      r0,[r0,r1,LSL #2]
000010  f8300012          LDRH     r0,[r0,r2,LSL #1]
000014  b100              CBZ      r0,|L4.24|
000016  1c5b              ADDS     r3,r3,#1
                  |L4.24|
000018  1c52              ADDS     r2,r2,#1              ;82
                  |L4.26|
00001a  4808              LDR      r0,|L4.60|
00001c  f8500021          LDR      r0,[r0,r1,LSL #2]     ;82
000020  4290              CMP      r0,r2                 ;82
000022  d8f2              BHI      |L4.10|
;;;85         } 
;;;86         return (used*100)/(memtblsize[memx]);  
000024  2064              MOVS     r0,#0x64
000026  4358              MULS     r0,r3,r0
000028  4c04              LDR      r4,|L4.60|
00002a  f8544021          LDR      r4,[r4,r1,LSL #2]
00002e  fbb0f0f4          UDIV     r0,r0,r4
000032  b2c0              UXTB     r0,r0
;;;87     }  
000034  bd10              POP      {r4,pc}
;;;88     //�ڴ����(�ڲ�����)
                          ENDP

000036  0000              DCW      0x0000
                  |L4.56|
                          DCD      mallco_dev+0x14
                  |L4.60|
                          DCD      memtblsize

                          AREA ||i.myfree||, CODE, READONLY, ALIGN=2

                  myfree PROC
;;;142    //ptr:�ڴ��׵�ַ 
;;;143    void myfree(u8 memx,void *ptr)  
000000  b570              PUSH     {r4-r6,lr}
;;;144    {  
000002  4605              MOV      r5,r0
000004  460c              MOV      r4,r1
;;;145    	u32 offset;   
;;;146    	if(ptr==NULL)return;//��ַΪ0.  
000006  b904              CBNZ     r4,|L5.10|
                  |L5.8|
;;;147     	offset=(u32)ptr-(u32)mallco_dev.membase[memx];     
;;;148        my_mem_free(memx,offset);	//�ͷ��ڴ�      
;;;149    }  
000008  bd70              POP      {r4-r6,pc}
                  |L5.10|
00000a  4805              LDR      r0,|L5.32|
00000c  f8500025          LDR      r0,[r0,r5,LSL #2]     ;147
000010  1a26              SUBS     r6,r4,r0              ;147
000012  4631              MOV      r1,r6                 ;148
000014  4628              MOV      r0,r5                 ;148
000016  f7fffffe          BL       my_mem_free
00001a  bf00              NOP      
00001c  e7f4              B        |L5.8|
;;;150    //�����ڴ�(�ⲿ����)
                          ENDP

00001e  0000              DCW      0x0000
                  |L5.32|
                          DCD      mallco_dev+0x8

                          AREA ||i.mymalloc||, CODE, READONLY, ALIGN=2

                  mymalloc PROC
;;;153    //����ֵ:���䵽���ڴ��׵�ַ.
;;;154    void *mymalloc(u8 memx,u32 size)  
000000  b570              PUSH     {r4-r6,lr}
;;;155    {  
000002  4604              MOV      r4,r0
000004  460e              MOV      r6,r1
;;;156        u32 offset;   
;;;157    	offset=my_mem_malloc(memx,size);  	   	 	   
000006  4631              MOV      r1,r6
000008  4620              MOV      r0,r4
00000a  f7fffffe          BL       my_mem_malloc
00000e  4605              MOV      r5,r0
;;;158        if(offset==0XFFFFFFFF)return NULL;  
000010  1c68              ADDS     r0,r5,#1
000012  b908              CBNZ     r0,|L6.24|
000014  2000              MOVS     r0,#0
                  |L6.22|
;;;159        else return (void*)((u32)mallco_dev.membase[memx]+offset);  
;;;160    }  
000016  bd70              POP      {r4-r6,pc}
                  |L6.24|
000018  4802              LDR      r0,|L6.36|
00001a  f8500024          LDR      r0,[r0,r4,LSL #2]     ;159
00001e  4428              ADD      r0,r0,r5              ;159
000020  e7f9              B        |L6.22|
;;;161    //���·����ڴ�(�ⲿ����)
                          ENDP

000022  0000              DCW      0x0000
                  |L6.36|
                          DCD      mallco_dev+0x8

                          AREA ||i.mymemcpy||, CODE, READONLY, ALIGN=1

                  mymemcpy PROC
;;;51     //n:��Ҫ���Ƶ��ڴ泤��(�ֽ�Ϊ��λ)
;;;52     void mymemcpy(void *des,void *src,u32 n)  
000000  b570              PUSH     {r4-r6,lr}
;;;53     {  
;;;54         u8 *xdes=des;
000002  4603              MOV      r3,r0
;;;55     	u8 *xsrc=src; 
000004  460c              MOV      r4,r1
;;;56         while(n--)*xdes++=*xsrc++;  
000006  e003              B        |L7.16|
                  |L7.8|
000008  f8145b01          LDRB     r5,[r4],#1
00000c  f8035b01          STRB     r5,[r3],#1
                  |L7.16|
000010  1e15              SUBS     r5,r2,#0
000012  f1a20201          SUB      r2,r2,#1
000016  d1f7              BNE      |L7.8|
;;;57     }  
000018  bd70              POP      {r4-r6,pc}
;;;58     //�����ڴ�
                          ENDP


                          AREA ||i.mymemset||, CODE, READONLY, ALIGN=1

                  mymemset PROC
;;;61     //count:��Ҫ���õ��ڴ��С(�ֽ�Ϊ��λ)
;;;62     void mymemset(void *s,u8 c,u32 count)  
000000  b530              PUSH     {r4,r5,lr}
;;;63     {  
;;;64         u8 *xs = s;  
000002  4603              MOV      r3,r0
;;;65         while(count--)*xs++=c;  
000004  e001              B        |L8.10|
                  |L8.6|
000006  f8031b01          STRB     r1,[r3],#1
                  |L8.10|
00000a  1e14              SUBS     r4,r2,#0
00000c  f1a20201          SUB      r2,r2,#1
000010  d1f9              BNE      |L8.6|
;;;66     }	   
000012  bd30              POP      {r4,r5,pc}
;;;67     //�ڴ�����ʼ��  
                          ENDP


                          AREA ||i.myrealloc||, CODE, READONLY, ALIGN=2

                  myrealloc PROC
;;;165    //����ֵ:�·��䵽���ڴ��׵�ַ.
;;;166    void *myrealloc(u8 memx,void *ptr,u32 size)  
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;167    {  
000004  4604              MOV      r4,r0
000006  460f              MOV      r7,r1
000008  4616              MOV      r6,r2
;;;168        u32 offset;    
;;;169        offset=my_mem_malloc(memx,size);   	
00000a  4631              MOV      r1,r6
00000c  4620              MOV      r0,r4
00000e  f7fffffe          BL       my_mem_malloc
000012  4605              MOV      r5,r0
;;;170        if(offset==0XFFFFFFFF)return NULL;     
000014  1c68              ADDS     r0,r5,#1
000016  b910              CBNZ     r0,|L9.30|
000018  2000              MOVS     r0,#0
                  |L9.26|
;;;171        else  
;;;172        {  									   
;;;173    	    mymemcpy((void*)((u32)mallco_dev.membase[memx]+offset),ptr,size);	//�������ڴ����ݵ����ڴ�   
;;;174            myfree(memx,ptr);  											  		//�ͷž��ڴ�
;;;175            return (void*)((u32)mallco_dev.membase[memx]+offset);  				//�������ڴ��׵�ַ
;;;176        }  
;;;177    }
00001a  e8bd81f0          POP      {r4-r8,pc}
                  |L9.30|
00001e  4908              LDR      r1,|L9.64|
000020  f8511024          LDR      r1,[r1,r4,LSL #2]     ;173
000024  1948              ADDS     r0,r1,r5              ;173
000026  4632              MOV      r2,r6                 ;173
000028  4639              MOV      r1,r7                 ;173
00002a  f7fffffe          BL       mymemcpy
00002e  4639              MOV      r1,r7                 ;174
000030  4620              MOV      r0,r4                 ;174
000032  f7fffffe          BL       myfree
000036  4802              LDR      r0,|L9.64|
000038  f8500024          LDR      r0,[r0,r4,LSL #2]     ;175
00003c  4428              ADD      r0,r0,r5              ;175
00003e  e7ec              B        |L9.26|
;;;178    
                          ENDP

                  |L9.64|
                          DCD      mallco_dev+0x8

                          AREA ||.ARM.__AT_0x68000000||, DATA, NOINIT, ALIGN=5

                  mem2base
                          %        4

                          AREA ||.ARM.__AT_0x68000004||, DATA, NOINIT, ALIGN=1

                  mem2mapbase
                          %        4

                          AREA ||.constdata||, DATA, READONLY, ALIGN=2

                  memtblsize
                          DCD      0x00000001
                          DCD      0x00000002
                          DCD      0x00000001
                  memblksize
                          DCD      0x00000001
                          DCD      0x00000002
                          DCD      0x00000001
                  memsize
                          DCD      0x00000001
                          DCD      0x00000004
                          DCD      0x00000001

                          AREA ||.data||, DATA, ALIGN=5

                  mem1base
000000  00000000          DCB      0x00,0x00,0x00,0x00
                          %        28
                  mem3base
000020  0000              DCB      0x00,0x00
                  mem1mapbase
000022  0000              DCB      0x00,0x00
                  mem3mapbase
000024  00000000          DCB      0x00,0x00,0x00,0x00
                  mallco_dev
                          DCD      my_mem_init
                          DCD      my_mem_perused
                          DCD      mem1base
                          DCD      mem2base
                          DCD      mem3base
                          DCD      mem1mapbase
                          DCD      mem2mapbase
                          DCD      mem3mapbase
000048  00000000          DCB      0x00,0x00,0x00,0x00

;*** Start embedded assembler ***

#line 1 "MALLOC\\malloc.c"
	AREA ||.rev16_text||, CODE
	THUMB
	EXPORT |__asm___8_malloc_c_4dd4ad64____REV16|
#line 388 ".\\CMSIS\\cmsis_armcc.h"
|__asm___8_malloc_c_4dd4ad64____REV16| PROC
#line 389

 rev16 r0, r0
 bx lr
	ENDP
	AREA ||.revsh_text||, CODE
	THUMB
	EXPORT |__asm___8_malloc_c_4dd4ad64____REVSH|
#line 402
|__asm___8_malloc_c_4dd4ad64____REVSH| PROC
#line 403

 revsh r0, r0
 bx lr
	ENDP
	AREA ||.rrx_text||, CODE
	THUMB
	EXPORT |__asm___8_malloc_c_4dd4ad64____RRX|
#line 587
|__asm___8_malloc_c_4dd4ad64____RRX| PROC
#line 588

 rrx r0, r0
 bx lr
	ENDP

;*** End   embedded assembler ***
